#!/bin/bash

# **IMPORTANT**
# **IMPORTANT** -- please read docs/build-docs.md before running this script!
# **IMPORTANT**

# This can only be done from a terminal; do not try to run it from cron or
# some other headless mechanism.  See "docs/build-docs.md" for why.

# Also, run it from the project root as "bin/build".

# how.html is special; it's a slide show that uses pandoc's "slidy" output
# format, so it's not part of the mkdocs thing at all.
cd how
[[ how.md -nt how.html ]] && {
    pandoc --embed-resources --standalone \
        -t slidy  \
        -H basic.css  \
        -H font-size.meta  \
        -o how.html \
        how.md
}
cd - >/dev/null

# also, a lot of things in here are kinda hardcoded to my setup; if someone
# really wants me to clean it up so that it is more generic, I'll work on it

die() { echo "$@"; exit 1; }

[ -f mkdocs.yml ] || die "are you sure you're in the right directory?"

[ -d .git/gen-docs ] && mv .git/gen-docs .

[ "$1" = "clean" ] && rm -rf gen-docs
mkdir -p gen-docs/{code,contrib,css}
rsync -a docs/code gen-docs
rsync -a docs/css  gen-docs
cp docs/gitweb.conf.html gen-docs
cp how/how.html gen-docs

cd docs

# generate images
for f in `find . -name "*.gv"; find . -name "*.aa"`
do
    new=${f/%aa/png}
    new=${new/%gv/png}
    [ -f ../gen-docs/$new ] && [ ../gen-docs/$new -nt $f ] && continue
    echo -n >&2 $f...
    ../bin/mkdocs.pre-build.image-gen $f ../gen-docs/$new
    echo >&2 "done"
done

# generate md with vim-syntax; this step is slow, but this is the simplest
# way to support gitolite syntax highlighting in arbitrary markdown.
for f in `find . -name "*.md" | sort`
do
    [ -f ../gen-docs/$f ] && [ ../gen-docs/$f -nt $f ] && continue
    echo -n >&2 $f...
    ../bin/mkdocs.pre-build.md-filter < $f > ../gen-docs/$f
    echo >&2 "done"
done

# build site
cd ..
mkdocs build

# DONE.  Now use the "site/" directory however you want
